var fullname,plural,description,where,reason,avatarImageSrc,imgs=[],imagesOK=0,imageURLs=[];const AVATAR=0,RECT=1,SQUARE=2,PROFILE=3,RECT_ENDORSE=4,RECT_ENDORSES=5,SQUARE_ENDORSE=6,SQUARE_ENDORSES=7,PP_PURPLE="#623894",prepareFontLoad=e=>Promise.all(e.map((e=>document.fonts.load(e))));async function startGeneratingImage(){jQuery("#generate").prop("disabled",!0),jQuery(".placeholder").hide();await prepareFontLoad(['400 italic 60px "Source Sans Pro"','100 60px "Source Sans Pro"','900 60px "Archivo Black"']),imgs=[],(imageURLs=[]).push(avatarImageSrc||"/img/avatar.png"),imageURLs.push("/img/rect-template.png"),imageURLs.push("/img/square-template.png"),imageURLs.push("/img/profile-example.png"),imageURLs.push("/img/rect-endorse.png"),imageURLs.push("/img/rect-endorses.png"),imageURLs.push("/img/square-endorse.png"),imageURLs.push("/img/square-endorses.png"),imagesOK=0,startLoadingAllImages(imagesAreNowLoaded)}function wordWrap(e,t,a,r,i){var n=e.split(/(\s+)/),s=[],g=0,l=0,d="",o=0,m=r?"-":"",u=a.measureText(m).width,h=0;if(a.measureText("M"+i+m).width>t)return[];for(var c=0,p=n.length;c<p;c++)if(g=a.measureText(n[c].replace(/\s+$/,"")).width+i*n[c].length,l=a.measureText(n[c]).width+i*n[c].length,o+g<t)d+=n[c],o+=l;else if(g<t)s.push(d),d=n[c],o=l;else for(var w=0,f=n[c].length;w<f;w++){if(h=a.measureText(n[c][w]).width+i,!n[c][w+1]||!/\S/.test(n[c][w+1])){o+h<t?(d+=n[c].substr(w),o+=a.measureText(n[c].substr(w)).width+i*n[c].substr(w).length):(d+=m,s.push(d),d=n[c].substr(w),o=a.measureText(n[c].substr(w)).width+i*n[c].substr(w).length);break}o+h+u<t?(d+=n[c][w],o+=h):(d+=m,s.push(d),d=n[c][w],o=h)}s.push(d);for(var x=0,v=s.length;x<v;x++)s[x]=s[x].replace(/\s+$/,"");return s}function deUnderline(e){return e.replace("_"," ")}function wrapText(e,t,a,r,i,n,s=0,g=!1){var l=wordWrap(t,i,e,!0,s);if(!g)for(var d=0,o=l.length;d<o;d++){var m=l[d];if(0===s)e.fillText(deUnderline(m),a,r+n*d);else{var u,h=e.measureText(m).width+s*(m.length-1);switch(e.textAlign){case"center":u=a-h/2;break;case"right":u=a-h;break;default:u=a}var c=e.textAlign;e.textAlign="left";for(var p=0;p<m.length;p++)e.fillText(deUnderline(m[p]),u,r+n*d),u+=s+e.measureText(m[p]).width;e.textAlign=c}}return n*l.length}function startLoadingAllImages(e){for(var t=0;t<imageURLs.length;t++){var a=new Image;imgs.push(a),a.onload=function(){++imagesOK>=imageURLs.length&&e()},a.onerror=function(){alert("image #"+t+" load failed: "+imageURLs[t])},a.src=imageURLs[t]}}function imagesAreNowLoaded(){drawRect(),drawSquare(),jQuery("#generate").prop("disabled",!1),jQuery(".initiallyHidden").show(),jQuery(".placeholder").hide()}function drawAvatar(e,t,a,r){var i=e.getContext("2d"),n=(e.width,t+r/2),s=(a=e.height-(a+r))+r/2,g=r,l=r;const d=g/l;i.save(),i.beginPath(),i.rect(n-g/2,s-l/2,g,l),i.clip();var o=imgs[0],m=o.naturalWidth/o.naturalHeight;m>d?i.drawImage(o,n-l*m/2,s-l/2,l*m,l):i.drawImage(o,n-g/2,s-g/m/2,g,g/m),i.restore()}function drawNameLine(e,t,a,r,i){var n=e.getContext("2d"),s=e.width,g=e.height-a;n.textAlign="left";for(var l=i;l>12&&(n.font="900 "+String(l)+"px 'Archivo Black', sans-serif",!(t+n.measureText(r).width<s-l));l-=1);n.fillStyle="#623894",n.fillText(r,t,g)}function drawDescriptionLine(e,t,a,r,i){var n=e.getContext("2d"),s=e.width,g=e.height-a;n.textAlign="left";for(var l=i;l>12&&(n.font="100 "+String(l)+"px 'Source Sans Pro',sans-serif",!(t+n.measureText(r).width<s-l));l-=1);n.fillStyle="#623894",n.fillText(r,t,g)}function drawWhyLines(e,t,a,r,i,n){var s=e.getContext("2d"),g=e.width,l=e.height-a;s.textAlign="left",s.fillStyle="#623894";for(var d=i;d>10;d-=1){s.font="400 italic "+String(d)+"px 'Source Sans Pro',sans-serif",textWidth=g-t-d/2;var o=wrapText(s,r,0,0,textWidth,1.1*d,0,!0);if(o<n)break}wrapText(s,r,t,l-o/2+d,textWidth,1.1*d,0)}function drawSquare(){var e=document.getElementById("squareCanvas"),t=e.getContext("2d"),a=e.width,r=e.height;t.clearRect(0,0,a,r);var i=imgs[2];t.drawImage(i,0,0,a,r),drawAvatar(e,40,765,275),drawNameLine(e,45,628,fullname,100);i=plural?imgs[6]:imgs[7];t.drawImage(i,0,0,a,r),drawDescriptionLine(e,45,580,description.length>0?description+" / "+where:where,40),drawWhyLines(e,350,878,reason,60,308),document.getElementById("squareImg").style.display="none";var n=e.toDataURL();document.getElementById("squareResult").src=n}function drawRect(){var e=document.getElementById("rectCanvas"),t=e.getContext("2d"),a=e.width,r=e.height;t.clearRect(0,0,a,r);var i=imgs[1];t.drawImage(i,0,0,a,r),drawAvatar(e,38,672,294),drawNameLine(e,36,567,fullname,100);i=plural?imgs[4]:imgs[5];t.drawImage(i,0,0,a,r),drawDescriptionLine(e,36,510,description.length>0?description+" / "+where:where,50),drawWhyLines(e,368,851,reason,100,260),document.getElementById("rectImg").style.display="none";var n=e.toDataURL();document.getElementById("rectResult").src=n}